# packs/lang/en-gb.yaml
# English (United Kingdom)
# Inherits from: default.yaml -> en.yaml

settings:
  # Match original Python stress timing (primaryStressDiv=1.5, secondaryStressDiv=1.2).
  # en.yaml has 1.4/1.1 which makes stressed syllables ~7% faster than original.
  primaryStressDiv: 1.5
  secondaryStressDiv: 1.2

  # Keep word-final long /uː/ (do/two/you) from sounding too clipped.
  englishLongUWordFinalScale: 1.00

  # Single-word tuning: original Python had no special single-word handling.
  # Reduce hold from en.yaml's 45ms to keep letters short and flat.
  singleWordFinalHoldMs: 0

  # Enable clause-final fade for stop aspiration at end of sentences.
  clauseFinalFadeMs: 0

  stopClosureAfterNasalsEnabled: true
  segmentBoundarySkipVowelToLiquid: false
  coarticulationEnabled: false
  coarticulationVelarPinchEnabled: false
  coarticulationGraduated: false
  coarticulationAdjacencyMaxConsonants: 2
  phraseFinalLengtheningEnabled: false
  phraseFinalLengtheningNucleusOnlyMode: false
  microprosodyEnabled: false
  microprosodyVoicelessF0RaiseEnabled: false
  microprosodyVoicedF0LowerEnabled: false
  rateReductionEnabled: false
  nasalizationAnticipatoryEnabled: false
  liquidDynamics:
    enabled: false
  lengthContrast:
    enabled: false
  allophoneRules:
    enabled: true
    rules:
    # ── /l/ darkness by position ─────────────────────────────────
    # RP has strong dark-l in coda. Slightly stronger than US values.
      - name: dark_l_post_vocalic
        phonemes: [l, ɫ]
        position: post-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.85
          - field: pf2
            targetHz: 900.0
            blend: 0.85

      - name: dark_l_syllabic
        phonemes: [l, ɫ]
        position: syllabic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.9
          - field: pf2
            targetHz: 900.0
            blend: 0.9

      - name: light_l_pre_vocalic
        phonemes: [l, ɫ]
        position: pre-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.2
          - field: pf2
            targetHz: 900.0
            blend: 0.2

  boundarySmoothing:
    enabled: false
  trajectoryLimit:
    enabled: false
    applyAcrossWordBoundary: false
  # ------------------------------------------------------------------
  # Special coarticulation for RP / British English.
  #
  # Key differences from en-us:
  #   - Non-rhotic: no rhotic vowel coloring (post-vocalic R is deleted
  #     by normalization; onset /ɹ/ before vowels doesn't strongly color
  #     the vowel in RP the way American R does).
  #   - Labial rounding is slightly less prominent.
  #   - Palatal fronting from /j/ (yod) — RP preserves yod in "tune",
  #     "new", "duke" where US drops it.  The /j/ raises F2 on the
  #     following vowel, brightening the onset.
  # ------------------------------------------------------------------
  specialCoarticulation:
    enabled: false
    maxDeltaHz: 350
    rules:
      # 1. Labial rounding — /w/, /b/, /p/, /m/ pull F2 down.
      #    Slightly less than US (RP labials are a touch less rounded).
      - name: labial-f2-lowering
        triggers: ["w", "b", "p", "m"]
        vowelFilter: all
        formant: f2
        deltaHz: -40
        side: both
        cumulative: false
        unstressedScale: 0.5

      # 2. Alveolar fronting of back vowels — /t/, /d/, /n/, /s/, /z/
      #    raise F2 on back vowels.  Similar to US.
      - name: alveolar-back-vowel-fronting
        triggers: ["t", "d", "n", "s", "z"]
        vowelFilter: back
        formant: f2
        deltaHz: 55
        side: both
        cumulative: false
        unstressedScale: 0.5

      # 3. Palatal fronting — /j/ (yod) raises F2 on the next vowel.
      #    Gives "tune" (tjuːn), "new" (njuː), "due" (djuː) a brighter
      #    onset that distinguishes RP from General American (which drops
      #    yod after alveolars).
      - name: palatal-f2-raising
        triggers: ["j"]
        vowelFilter: all
        formant: f2
        deltaHz: 70
        side: right           # only the vowel *after* /j/
        cumulative: false
        unstressedScale: 0.4

  # ------------------------------------------------------------------
  # Cluster timing for RP.
  # RP keeps consonant clusters a bit more distinct than casual American
  # English, so the scaling is more conservative (closer to 1.0).
  # ------------------------------------------------------------------
  clusterTiming:
    enabled: false
    fricBeforeStopScale: 0.75      # /st/ in "stop", "fast"
    stopBeforeFricScale: 0.80      # /ks/ in "box", "tax"
    fricBeforeFricScale: 0.80      # /sf/ rare
    stopBeforeStopScale: 0.70      # /kt/ in "act", "fact"
    tripleClusterMiddleScale: 0.65 # middle C in /str/, /kst/
    affricateInClusterScale: 0.80  # /tʃ/ in "lunchbox"
    wordMedialConsonantScale: 0.90 # intervocalic C's
    wordFinalObstruentScale: 0.95  # RP enunciates final obstruents more
  legacyPitchMode: espeak_style
  legacyPitchInflectionScale: 0.56
normalization:
  preReplacements:
    # Undo en.yaml's ʊ→ʊ̞ for UK English.
    # Original data.py used plain ʊ (cf1=405, cf2=900).
    # ʊ̞ (cf1=430, cf2=1020) is too front for RP GOAT diphthong.
    - from: "ʊ̞"
      to:   "ʊ"

    # Non-rhotic: drop post-vocalic /ɹ/ FIRST, before vowel sequence
    # collapse rules run (e.g. iə → iᵊ needs ɹ gone to see word-end).
    - from: "ɹ"
      to:   ""
      when:
        afterClass: VOWELISH
        atWordEnd: true
    - from: "ɹ"
      to:   ""
      when:
        afterClass: VOWELISH
        beforeClass: CONSONANTS
    - from: "r"
      to:   ""
      when:
        afterClass: VOWELISH
        atWordEnd: true
    - from: "r"
      to:   ""
      when:
        afterClass: VOWELISH
        beforeClass: CONSONANTS
  classes:
    BATH_FOLLOW: ["s", "f", "θ"]

    # Vowel-like tokens used to detect post-vocalic /r/ contexts.
    VOWELISH:
      - "0"
      - "3"
      - "@"
      - "E"
      - "I"
      - "O"
      - "U"
      - "V"
      - "a"
      - "e"
      - "i"
      - "o"
      - "oː"
      - "u"
      - "y"
      - "yː"
      - "Ã"
      - "á"
      - "ã"
      - "æ"
      - "é"
      - "í"
      - "ó"
      - "õ"
      - "ø"
      - "øː"
      - "ú"
      - "ĩ"
      - "ő"
      - "œ"
      - "ũ"
      - "ű"
      - "ɐ"
      - "ɑ"
      - "ɑj"
      - "ɑw"
      - "ɑ̃"
      - "ɒ"
      - "ɔ"
      - "ɔ_r"
      - "ɔj"
      - "ɘ"
      - "ə"
      - "ə͡l"
      - "ɚ"
      - "ɛ"
      - "ɜ"
      - "ɝ"
      - "ɤ"
      - "ɨ"
      - "ɪ"
      - "ɯ"
      - "ɵ"
      - "ʉ"
      - "ʊ"
      - "ʊ̞"
      - "ʌ"
      - "ʏ"
      - "ᴀ"
      - "ᴇ"
      - "ᴏ"
      - "ᴐ"
      - "ᴒ"
      - "ᴜ"
      - "ᵁ"
      - "ᵃ"
      - "ᵒ"
      - "ᵻ"
      - "ᵾ"
      - "ᵿ"
      - "ẽ"
      - "ᵊ"
      - "ᵊᵉ"

    # All consonant tokens in the phoneme table (used to detect /r/ before a consonant).
    CONSONANTS:
      - "?"
      - "b"
      - "c"
      - "d"
      - "d͡z"
      - "d͡ʐ"
      - "d͡ʑ"
      - "d͡ʒ"
      - "f"
      - "g"
      - "h"
      - "j"
      - "k"
      - "l"
      - "m"
      - "n"
      - "p"
      - "r"
      - "s"
      - "t"
      - "t(3"
      - "t͡s"
      - "t͡ɕ"
      - "t͡ʂ"
      - "t͡ʃ"
      - "v"
      - "w"
      - "x"
      - "z"
      - "ç"
      - "ð"
      - "ŋ"
      - "ɕ"
      - "ɟ"
      - "ɟʲ"
      - "ɡ"
      - "ɣ"
      - "ɧ"
      - "ɫ"
      - "ɲ"
      - "ɲʲ"
      - "ɹ"
      - "ɻ"
      - "ɽ"
      - "ɾ"
      - "ʁ"
      - "ʂ"
      - "ʃ"
      - "ʍ"
      - "ʎ"
      - "ʐ"
      - "ʑ"
      - "ʒ"
      - "ʔ"
      - "ʝ"
      - "β"
      - "θ"
      - "ᴊ"
      - "ᵂ"
      - "ᵊ"
      - "ᵊᵉ"

  replacements:
    # TRAP/BATH (eSpeak en-gb uses 'a' for both): map only the BATH set.
    #
    # Important: leave the remaining 'a' alone (TRAP) so words like "app", "application"
    # don't drift to an "ah" quality.
    # ᵅ is the UK RP PALM/START vowel (F2=1200, properly back "ah").
    - from: "a"
      to: "ᵅː"
      when:
        beforeClass: BATH_FOLLOW

    # Safety: if 'æ' shows up (from other normalizers), treat it as TRAP 'a' unless it
    # is in the BATH environment.
    - from: "æ"
      to: "ᵅː"
      when:
        beforeClass: BATH_FOLLOW
    - from: "æ"
      to:   "a"

    # UK THOUGHT: keep native ɔ (cf1=450, cf2=870) — matches original.
    # The ᴏ variant (cf1=610, cf2=1000) was too open and flat.

    # Non-rhotic NURSE: if any rhotic NURSE slips in, de-rhoticize.
    - from: "ɝː"
      to: "ɜː"
    - from: "ɝ"
      to: "ɜ"

    # NEAR vowel (fear, hear, dear): collapse word-final iə to a single
    # vowel with a short schwa tail. Original Python played i+ə directly;
    # the ˈiə→ˈɪə lowering rule was removed (made NEAR sound like two beats).
    - from: "iə"
      to:   "iᵊ"
      when:
        atWordEnd: true
    - from: "i͡ə"
      to:   "iᵊ"
      when:
        atWordEnd: true

    # Make /d͡ʒ/ a little less 'soft' by keeping the stop+fricative components explicit.
    - from: "d͡ʒ"
      to:   "dʒ"

    # Non-rhotic ɹ-drop moved to preReplacements (must run before NEAR collapse).