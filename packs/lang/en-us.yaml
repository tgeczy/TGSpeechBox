# packs/lang/en-us.yaml
# English (US) overrides layered on top of default.yaml + en.yaml

settings:
  # Keep stop closures for clarity, but avoid the overly-clicky "always" mode
  # (helps clusters like "adjust" and "change" feel less springy).
  stopClosureMode: vowel-and-cluster
  # If a word ends in a consonant and the next word starts with a stop,
  # that word-initial stop can get swallowed (e.g. "... applications toolbar").
  # Turn on cluster gaps, and make *word-boundary* cluster gaps slightly longer
  # than in-word clusters for clarity, without going full "always".
  stopClosureClusterGapsEnabled: true
  stopClosureAfterNasalsEnabled: true

  # Allow gaps after nasals too, so phrases like "column two" don't swallow the /t/.
  stopClosureVowelGapMs: 18
  stopClosureVowelFadeMs: 4
  stopClosureClusterGapMs: 20
  stopClosureClusterFadeMs: 16
  stopClosureWordBoundaryClusterGapMs: 24
  stopClosureWordBoundaryClusterFadeMs: 4

  # Append a short silence token at end of utterance so the DSP can
  # crossfade aspiration/frication through voiceGenerator instead of
  # hitting the crude 4ms stopFade path.
  singleWordFinalFadeMs: 25
  clauseFinalFadeMs: 15

  # US: smoother overall, less breath noise on stop releases.
  postStopAspirationEnabled: true

  # Reduce hold time for word-final liquids (R, L) to avoid "pirate R" on
  # words like "star", "car", "far". The retroflex R with its low F3 sounds
  # unnatural when held too long. 0.4 = 40% of normal hold time.
  singleWordFinalLiquidHoldScale: 0.4

  # US tends to shorten length-marked vowels in word-final closed syllables
  # (e.g. "tools", "smooth").
  lengthenedVowelFinalCodaScale: 0.75

  # Allow length marks to apply to consonants too (for word-final R lengthening)
  applyLengthenedScaleToVowelsOnly: false
  # Make length marks more effective.
  # 1.05 was too subtle - FORCE vowels (for, door, snore) need more presence before R.
  # With 1.10, a double length mark (ːː) gives ~32% more length.
  lengthenedScale: 1.10

  # Use the US/CA GOOSE vowel variant.
  englishLongUShortenEnabled: true
  englishLongUWordFinalScale: 0.95
  englishLongUKey: "ᵿ"

  spellingDiphthongMode: monophthong
  autoTieDiphthongs: true

  # Shorten semivowel offglides (e.g. /w/ in "why" /waɪ/, /j/ in "yes" /jɛs/).
  # Keeps glide-like segments quick and natural-sounding.
  # NOTE: FACE/GOAT diphthongs now use the collapse pass instead of semivowel rewrites.
  semivowelOffglideScale: 0.65

  # Keep defaults conservative: avoid heavy cross-phoneme shaping here.
  coarticulationEnabled: true
  trajectoryLimitEnabled: true
  microprosodyEnabled: true
  segmentBoundarySkipVowelToLiquid: false
  coarticulationVelarPinchEnabled: false
  coarticulationGraduated: false
  coarticulationAdjacencyMaxConsonants: 0
  # Right-side (coda) coarticulation: vowel endpoints transition toward
  # following consonant's locus. Crucial for /n/ vs /ŋ/ and all coda place cues.
  coarticulationRightSideScale: 0.7
  # Velar locus splits by vowel context. Before back vowels (/oʊ/, /uː/, /ɑ/),
  # velars start low — tongue body pulling away from soft palate creates a
  # natural glide. Before front vowels, velars stay high.
  coarticulationVelarF2LocusFront: 1800
  coarticulationVelarF2LocusBack: 1100
  phraseFinalLengtheningEnabled: true
  phraseFinalLengtheningNucleusOnlyMode: false
  phraseFinalLengtheningFinalSyllableScale: 1.05
  # Monophthongs ("top", "list", "fox") get more room to lengthen.
  # Diphthongs ("eight", "same", "I") are already long, gentle boost only.
  phraseFinalLengtheningNucleusScale: 1.22
  phraseFinalLengtheningNucleusDiphthongScale: 1.08
  phraseFinalLengtheningCodaScale: 1.10
  phraseFinalLengtheningCodaStopScale: 1.0
  phraseFinalLengtheningCodaFricativeScale: 1.15
  # Phrase-final nasal sustain: nasals linger at clause boundaries.
  phraseFinalLengtheningCodaNasalScale: 1.25
  phraseFinalLengtheningPenultimateSyllableScale: 1.08
  phraseFinalLengtheningStatementScale: 1.0
  phraseFinalLengtheningQuestionScale: 0.85
  microprosodyVoicelessF0RaiseEnabled: false
  microprosodyVoicelessF0RaiseHz: 12.0
  microprosodyVoicedF0LowerEnabled: true
  microprosodyVoicedF0LowerHz: 4.0
  microprosodyVoicedFricativeLowerScale: 0.5

  # Following-consonant F0: vowel END pitch adjusts to what comes next.
  microprosodyFollowingF0Enabled: true
  microprosodyFollowingVoicelessRaiseHz: 3.0
  microprosodyFollowingVoicedLowerHz: 2.0

  # Intrinsic vowel F0: high vowels naturally higher-pitched than low.
  microprosodyIntrinsicF0Enabled: true
  microprosodyIntrinsicF0HighThreshold: 400.0
  microprosodyIntrinsicF0LowThreshold: 600.0
  microprosodyIntrinsicF0HighRaiseHz: 3.0
  microprosodyIntrinsicF0LowDropHz: 2.0

  # Pre-voiceless shortening: "bat" vowel shorter than "bad" vowel.
  # MacinTalk: 55% before voiceless stops, 80% before fricatives.
  # Klatt (1976): vowels 60-70% as long before voiceless vs voiced.
  # 0.80 is a moderate compromise (was 0.92, barely perceptible).
  microprosodyPreVoicelessShortenEnabled: true
  microprosodyPreVoicelessShortenScale: 0.80
  microprosodyPreVoicelessMinMs: 35.0

  # Voiceless coda lengthening: complement to pre-voiceless shortening.
  # When a vowel shrinks before a voiceless consonant, the consonant grows for consistency.
  microprosodyVoicelessCodaLengthenEnabled: true
  microprosodyVoicelessCodaLengthenScale: 1.20

  # Safety cap: total F0 perturbation per vowel can't exceed this.
  microprosodyMaxTotalDeltaHz: 10.0
  nasalizationAnticipatoryEnabled: false
  prominence:
    enabled: true

    # English: stress marks are the primary source. Vowel length is
    # phonemic but eSpeak already marks stress, so longVowelWeight
    # is low. Word-initial boost gives a subtle naturalness nudge.
    primaryStressWeight: 1.45
    secondaryStressWeight: 1.20
    longVowelWeight: 0.0          # English stress is lexical, not length-based
    longVowelMode: "never"

    wordInitialBoost: 0.05
    wordFinalReduction: 0.05

    # Duration: prominent syllables hold steady, unstressed ones can shrink.
    # MacinTalk: word-medial unstressed at 55%, others at 70%.
    # 0.85 is conservative but gives more rhythmic contrast than 0.92.
    durationProminentFloorMs: 55
    durationPrimaryFloorMs: 95
    durationReducedCeiling: 0.85

    # Amplitude: subtle contour shaping
    amplitudeBoostDb: 0.3
    amplitudeReductionDb: 0.0

    # Let prominence drive Fujisaki accents
    pitchFromProminence: true
  liquidDynamics:
    enabled: true
    # American-style rhotic quality - creates movement in the R
    rhoticF3Dip:
      enabled: false
      # Raised from 1450 to reduce "Australian" tongue-press sound
      f3Minimum: 1550
      # Reduced from 0.45 to make R feel less "drawn out"
      dipDurationPct: 0.25
  diphthongCollapse:
    enabled: true
    durationFloorMs: 60
    onsetHoldExponent: 1.7
    microFrameIntervalMs: 8
  lengthContrast:
    enabled: false
  allophoneRules:
    enabled: true
    rules:
    # ── Stop aspiration scaling ──────────────────────────────────
    # Disabled: these weren't active before and cause regression on
    # numbers like "442" where word-boundary /t/ needs full aspiration.
    #- name: aspiration_word_initial_stressed
    #  tokenType: aspiration
    #  position: word-initial
    #  stress: prev-stressed
    #  action: scale
    #  durationScale: 0.8
    #  fadeScale: 0.8
    #  fieldScales:
    #    aspirationAmplitude: 0.8
    #    fricationAmplitude: 0.8

    #- name: aspiration_word_initial
    #  tokenType: aspiration
    #  position: word-initial
    #  stress: unstressed
    #  action: scale
    #  durationScale: 0.5
    #  fadeScale: 0.5
    #  fieldScales:
    #    aspirationAmplitude: 0.5
    #    fricationAmplitude: 0.5

    #- name: aspiration_word_final
    #  tokenType: aspiration
    #  position: word-final
    #  action: scale
    #  durationScale: 0.1
    #  fadeScale: 0.1
    #  fieldScales:
    #    aspirationAmplitude: 0.1
    #    fricationAmplitude: 0.1

    #- name: aspiration_intervocalic
    #  tokenType: aspiration
    #  position: intervocalic
    #  action: scale
    #  durationScale: 0.2
    #  fadeScale: 0.2
    #  fieldScales:
    #    aspirationAmplitude: 0.2
    #    fricationAmplitude: 0.2

    # ── Intervocalic flapping (/t,d/ → [ɾ]) ─────────────────────
      - name: american_flapping
        phonemes: [t, d]
        position: intervocalic
        stress: next-unstressed
        action: replace
        replaceTo: ɾ
        replaceDurationMs: 30.0
        replaceRemovesClosure: true
        replaceClosureScale: 0.5
        replaceRemovesAspiration: false

    # ── /l/ darkness by position ─────────────────────────────────
      - name: dark_l_post_vocalic
        phonemes: [l, ɫ]
        position: post-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.8
          - field: pf2
            targetHz: 900.0
            blend: 0.8

      - name: dark_l_syllabic
        phonemes: [l, ɫ]
        position: syllabic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.9
          - field: pf2
            targetHz: 900.0
            blend: 0.9

      - name: light_l_pre_vocalic
        phonemes: [l, ɫ]
        position: pre-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.2
          - field: pf2
            targetHz: 900.0
            blend: 0.2

    # ── Post-sibilant aspiration suppression ─────────────────────
    # English voiceless stops are unaspirated after /s/ and /ʃ/:
    # "style" vs "tile", "spin" vs "pin", "skin" vs "kin".
    # The 'after' filter on aspiration tokens looks past the parent
    # stop to check the preceding phoneme.
      - name: post_sibilant_aspiration_suppress
        tokenType: aspiration
        after: ["s", "ʃ"]
        action: scale
        durationScale: 0.05
        fieldScales:
          aspirationAmplitude: 0.05
          fricationAmplitude: 0.05

    # ── Glottal reinforcement (word-final voiceless stops) ───────
    # Disabled: the unreleased rule already softens word-final stops,
    # and the inserted [ʔ] was adding too much to the cluster.
    #- name: glottal_reinforcement
    #  flags: [stop]
    #  notFlags: [voiced]
    #  position: word-final
    #  action: insert-before
    #  insertPhoneme: ʔ
    #  insertDurationMs: 18.0
    #  insertFadeMs: 3.0
    #  insertContexts: ["V_#"]

    # ── Unreleased word-final stops (softer, airier release) ─────
    # Spectral shaping: cut low-freq thump (pa1, pa2), boost high-freq
    # air (pa4, pa5) to make the burst sound released-but-soft rather
    # than hard and clicky. Works within the existing time budget —
    # no extra tokens, no added gaps.
      - name: unreleased_word_final
        flags: [stop]
        notFlags: [voiced]
        position: word-final
        action: scale
        durationScale: 0.85
        fieldScales:
          fricationAmplitude: 0.84
          aspirationAmplitude: 0.55
          pa1: 0.3
          pa2: 0.5
          pa4: 1.3
          pa5: 1.4
  boundarySmoothing:
    enabled: true

    # ── Global fallbacks (used when consonant place is unknown) ──
    f1Scale: 0.50
    f2Scale: 0.50
    f3Scale: 0.80        # was 1.2 — pre-silence protection now handles
                          # utterance-final metallic bends; this can be
                          # tighter without hurting "three" etc.

    nasalF1Instant: true
    nasalF2F3SpansPhone: true

    # ── Fade durations (ms) ──
    # Liquid↔vowel gets extra room — /ɹ/ has the largest F3 excursion
    # in English (~1700→2500 Hz) and needs time to resolve.
    liquidToVowelFadeMs: 22   # was 14 default — huge F3 swing needs room
    vowelToLiquidFadeMs: 20   # was 14 default
    stopToVowelFadeMs: 20
    vowelToStopFadeMs: 22
    fricToVowelFadeMs: 18
    vowelToFricFadeMs: 18
    nasalToVowelFadeMs: 16
    vowelToNasalFadeMs: 16
    nasalToStopFadeMs: 12
    liquidToStopFadeMs: 12
    fricToStopFadeMs: 10
    stopToFricFadeMs: 15
    vowelToVowelFadeMs: 20

    # ── Per-place transition speeds ──
    #
    # These control what fraction of the fade time each formant uses
    # to reach its target.  Lower = faster arrival, higher = slower.
    # The key insight: the formant that carries the PLACE CUE for each
    # articulator must be slow enough to be heard, or the consonant
    # loses its identity.
    #
    # NOTE: /ɹ/ and /l/ are classified alveolar by place but are
    # approximants with complex tongue shapes.  The alveolar values
    # below compromise between fast /t/,/d/,/s/ and slow /ɹ/,/l/.
    # A future code-level liquid override would let us tighten these.

    # Labial (/b/, /p/, /m/, /f/, /v/)
    # Lips are light and independent of tongue — F2/F3 drift gently.
    labialF1Scale: 0.30      # jaw drops fast, lips don't impede
    labialF2Scale: 0.55      # lips don't drag the tongue — F2 drifts
    labialF3Scale: 0.55      # same — tongue barely involved

    # Alveolar (/t/, /d/, /n/, /s/, /z/, /ɹ/, /l/)
    # Tongue tip is fast for stops/fricatives, but /ɹ/ and /l/ live
    # here too and their F3 transitions are large.  F3 kept moderate
    # to protect /ɹ/ → vowel from spiking.
    alveolarF1Scale: 0.40    # jaw — moderate
    alveolarF2Scale: 0.50    # compromise: fast enough for /s/, safe for /ɹ/
    alveolarF3Scale: 0.65    # MUST be slow — /ɹ/ F3 jumps 700+ Hz

    # Palatal/postalveolar (/ʃ/, /ʒ/, /tʃ/, /dʒ/, /j/)
    # Tongue blade — F3 IS the place cue.  Rushing it erases /ʃ/ vs /s/.
    palatalF1Scale: 0.35     # jaw — moderate
    palatalF2Scale: 0.55     # blade is medium speed
    palatalF3Scale: 0.75     # SLOW — low F3 region must linger

    # Velar (/k/, /ɡ/, /ŋ/)
    # Tongue body — heaviest articulator.  F2 transition IS the velar
    # cue.  F2-F3 convergence (velar pinch) needs time to develop.
    velarF1Scale: 0.35       # jaw — moderate
    velarF2Scale: 0.65       # SLOW — tongue body is heavy, F2 IS identity
    velarF3Scale: 0.60       # slow — pinch convergence needs time
  trajectoryLimit:
    enabled: true
    applyAcrossWordBoundary: true
    windowMs: 25
    liquidRateScale: 1.5
    applyTo: [cf2, cf3, pf2, pf3]
    maxHzPerMs:
      cf2: 26
      cf3: 22
      pf2: 18
      pf3: 22
  # ------------------------------------------------------------------
  # Special coarticulation: YAML-driven Hz deltas on vowels adjacent
  # to specific consonants.  Runs *after* the locus coarticulation pass,
  # so these deltas stack on top of formant ramps.
  # ------------------------------------------------------------------
  specialCoarticulation:
    enabled: true
    maxDeltaHz: 400
    rules:
      # 1. Rhotic vowel coloring  (the signature American feature).
      #    /ɹ/ and /ɻ/ pull F3 down on the vowel next to them.
      #    liquid_dynamics handles the R *token* itself; this colors
      #    the *vowel* token, which is the perceptual cue for rhoticity.
      - name: rhotic-f3-lowering
        triggers: ["ɹ", "ɻ"]
        vowelFilter: all
        formant: f3
        deltaHz: -80
        side: both
        cumulative: true        # V between two R's gets double dose
        unstressedScale: 0.6    # less effect on reduced vowels
        phraseFinalStressedScale: 1.3  # phrase-final "star" gets extra color

      # 2. Labial rounding  — /w/, /b/, /p/, /m/ pull F2 down.
      #    Makes "water", "between", "maple" sound rounder.
      - name: labial-f2-lowering
        triggers: ["w", "b", "p", "m"]
        vowelFilter: all
        formant: f2
        deltaHz: -50
        side: both
        cumulative: false
        unstressedScale: 0.5

      # 3. Alveolar fronting of back vowels  — /t/, /d/, /n/, /s/, /z/
      #    raise F2 on back vowels, subtly fronting them.
      #    Replaces the old hardcoded alveolar-back-vowel experiment
      #    that was just removed from coarticulation.cpp.
      - name: alveolar-back-vowel-fronting
        triggers: ["t", "d", "n", "s", "z"]
        vowelFilter: back
        formant: f2
        deltaHz: 60
        side: both
        cumulative: false
        unstressedScale: 0.5

      # 4. Pre-velar F2 raise — vowels before any velar (/ŋ/, /k/, /ɡ/)
      #    get F2 raised toward velar territory.  This is the main cue
      #    that separates "food" from "foog" and "ban" from "bang" —
      #    the vowel signals a velar is coming.
      - name: pre-velar-f2-raise
        triggers: ["ŋ", "k", "ɡ", "g"]
        vowelFilter: all
        formant: f2
        deltaHz: 80
        side: right
        cumulative: false
        unstressedScale: 0.7

      # 5. Pre-velar F3 lower — the velar pinch.  Rule 4 raises F2,
      #    this one lowers F3.  Together they create the characteristic
      #    F2/F3 convergence that marks velar place in the preceding
      #    vowel — works for "bang", "back", and "bag" alike.
      - name: pre-velar-f3-lower
        triggers: ["ŋ", "k", "ɡ", "g"]
        vowelFilter: all
        formant: f3
        deltaHz: -100
        side: right
        cumulative: false
        unstressedScale: 0.7

  # ------------------------------------------------------------------
  # Cluster timing: shorten consonants in clusters so "adjust",
  # "texts", "strengths" don't sound like each consonant was
  # dictated separately.  Also trims word-medial and word-final
  # obstruents for smoother connected speech.
  # ------------------------------------------------------------------
  clusterTiming:
    enabled: true
    fricBeforeStopScale: 0.65      # /st/ in "stop", "fast"
    stopBeforeFricScale: 0.70      # /ks/ in "box", "tax"
    fricBeforeFricScale: 0.75      # /sf/ rare but "asphalt"
    stopBeforeStopScale: 0.60      # /kt/ in "act", "fact"
    tripleClusterMiddleScale: 0.55 # middle C in /str/, /kst/
    affricateInClusterScale: 0.75  # /tʃ/ in "lunchbox"
    wordMedialConsonantScale: 0.90 # intervocalic C's
    wordFinalObstruentScale: 0.90  # final /t/, /d/, /s/ etc.

  clusterBlend:
    enabled: true
    forwardDriftStrength: 0.30

  # ------------------------------------------------------------------
  # Rate compensation: enforce perceptual duration floors at high speed.
  # Prevents speed compression from crushing segments below audibility.
  # At normal speed (1x) this pass does nothing — your cluster timing,
  # prominence, and other artistic tuning are untouched.
  # Only kicks in when speed pushes absolute durations below the floors.
  # ------------------------------------------------------------------
  rateCompensation:
    enabled: true
    minimumDurations:
      vowelMs: 20     # formant identity needs ~20 to 30ms to establish F1/F2
      fricativeMs: 18       # spectral noise identity needs multiple cycles
      stopMs: 4             # already tiny — protect what's left of the burst
      nasalMs: 18           # place perception (/ɲ/ vs /n/ vs /ŋ/)
      liquidMs: 15           # /ɹ/ and /l/ need F3 transition time
      affricateMs: 12        # shorter than fricative, longer than stop
      semivowelMs: 10        # glide needs some trajectory to register
      tapMs: 4               # quick by nature, don't over-protect
      trillMs: 12            # needs at least one modulation cycle
      voicedConsonantMs: 10  # catch-all for voiced C's not matched above

    # Word-final segments carry morphological load in English:
    # plural /s/, past tense /d/, possessive /z/. Extra protection.
    wordFinalBonusMs: 5

    # 0.0 = rigid floors at all speeds (recommended to start).
    # Increase toward 1.0 if floors make 4x+ speech feel too slow.
    floorSpeedScale: 0.0

    # When a floor bumps one consonant in a cluster, its neighbors
    # can end up disproportionately short — creating a "bulge".
    # This smooths the ratios back toward their pre-floor proportions.
    clusterProportionGuard: true
    clusterMaxRatioShift: 0.4

    # Rate-dependent schwa shortening (absorbed from old reduction pass).
    # Off for now — enable once base floors are tuned and sounding right.
    schwaReduction:
      enabled: false
      threshold: 2.5
      scale: 0.8

  syllableDuration:
    enabled: true
    onsetScale: 1.10
    codaScale: 0.85
    unstressedOpenNucleusScale: 0.90

  syllableStructure:
    # Legal word-initial onset clusters for English.
    # Used by the text parser's onset maximization to place syllable
    # boundaries at linguistically correct positions.
    legalOnsets:
      # CC: stop + liquid/glide
      - pl
      - pɹ
      - bl
      - bɹ
      - tɹ
      - tw
      - dɹ
      - dw
      - kl
      - kɹ
      - kw
      - ɡl
      - ɡɹ
      - ɡw
      # CC: fricative + liquid/nasal/glide
      - fl
      - fɹ
      - fj
      - θɹ
      - sl
      - sm
      - sn
      - sp
      - st
      - sk
      - sw
      - ʃɹ
      - vj
      - hj
      # CC: other
      - bj
      - pj
      - pw
      - kj
      - tj
      - dj
      - mj
      - nj
      - lj
      # CCC: s + stop + liquid/glide
      - spl
      - spɹ
      - stɹ
      - skɹ
      - skw
      - skl
      # CCC: s + stop + j
      - spj
      - stj
      - skj

  legacyPitchMode: espeak_style
  legacyPitchInflectionScale: 0.56
  singleWordClauseTypeOverrideCommaOnly: false
normalization:
  preReplacements:
    # FORCE vowels: Shorten the vowel when followed by a consonant (short, sport, report).
    # Open FORCE (door, score, for) keeps its natural length.
    # Must run FIRST, before tie-bar normalization and ᵊ insertion.
    - from: "oːɹ"
      to:   "oɹ"
      when:
        beforeClass: CONSONANTS
    - from: "ɔːɹ"
      to:   "ɔɹ"
      when:
        beforeClass: CONSONANTS

    # Protect PRICE/MOUTH diphthongs from broad TRAP rules (e.g. five/nine/out).
    # With tie-insensitive rule matching in the frontend, these match both 'aɪ' and 'a͡ɪ'.
    - from: "a͡ɪ"
      to:   "ɑ͡ɪ"
    - from: "a͡ʊ"
      to:   "ɑ͡ʊ"

    # FACE/GOAT/CHOICE diphthongs: autoTieDiphthongs handles tying now.
    # The onset-must-be-vowel fix prevents false ties on w+ɪ (quick/with).
    # PRICE/MOUTH still get explicit tie bars from the ɑ͡ɪ/ɑ͡ʊ rules above.

    # FORCE vowels: The vowel before R gets swallowed too quickly.
    # Some consonants (f, m, b, d, st, word-initial) cause extra shortening.
    # Insert short ᵊ (semivowel) transition to give the vowel more presence.
    # f + FORCE (for, four):
    - from: "fˈoːɹ"
      to:   "fˈoːᵊɹ"
    - from: "fɔːɹ"
      to:   "fɔːᵊɹ"
    - from: "foːɹ"
      to:   "foːᵊɹ"
      # m + FORCE (more):
    - from: "mˈoːɹ"
      to:   "mˈoːᵊɹ"
    - from: "moːɹ"
      to:   "moːᵊɹ"
    # b + FORCE (bore, boar):
    - from: "bˈoːɹ"
      to:   "bˈoːᵊɹ"
    - from: "boːɹ"
      to:   "boːᵊɹ"
    # d + FORCE (door):
    - from: "dˈoːɹ"
      to:   "dˈoːᵊɹ"
    - from: "doːɹ"
      to:   "doːᵊɹ"
    # st + FORCE (store):
    - from: "stˈoːɹ"
      to:   "stˈoːᵊɹ"
    - from: "stoːɹ"
      to:   "stoːᵊɹ"
  classes:
    # Vowels (including schwa/r-colored and extra internal keys used by English packs).
    VOWELS: ["a", "e", "i", "o", "u", "ɐ", "ə", "ɜ", "ɝ", "ɑ", "ɒ", "ɔ", "ɛ", "æ", "ʊ", "ɪ", "ᵾ", "ᵿ", "ᴏ", "ᴐ", "ᴒ", "ã", "ẽ", "ĩ", "õ", "ũ", "ᴜ"]

    # Consonants (used for notBeforeClass checks, e.g. FORCE vowel lengthening).
    CONSONANTS: ["b", "c", "d", "f", "g", "h", "j", "k", "l", "m", "n", "p", "q", "r", "s", "t", "v", "w", "x", "z", "ŋ", "ɡ", "ɣ", "ɫ", "ɲ", "ɹ", "ɻ", "ɾ", "ʃ", "ʒ", "ʔ", "θ", "ð", "ç", "β", "t͡ʃ", "d͡ʒ", "t͡s", "d͡z"]

  replacements:
    # eSpeak (classic) en-us has a dictionary entry for "Microsoft" that produces
    # an "-soft" syllable with /ɑː/ ("microsaft"). "soft" by itself is /sɔft/.
    # Normalize the compound to use the same vowel as "soft".
    - from: "sˌɑːft"
      to:   "sˌɔft"
    - from: "sˌɑft"
      to:   "sˌɔft"

    # FACE (eɪ): Let the diphthong collapse pass handle the formant sweep.
    # Previously rewrote eɪ→ej (semivowel offglide) to avoid two-beat artifact,
    # but the collapse pass now merges tied vowel pairs into cosine-smoothed
    # micro-frames — no workaround needed.

    # GOAT (oʊ): Let the diphthong collapse pass handle the formant sweep.
    # Previously monophthongized specific words (no/go/so) and stripped offglides
    # from unstressed prefixes (okay, obey) to avoid "oww" from the ow semivowel.
    # The collapse pass now merges oʊ into a smooth ᵒ→ʊ cosine glide.
    # The o→ᵒ fronting rule below still fires on the onset vowel — collapse
    # sees ᵒ+ʊ as two tied vowels and sweeps from ᵒ formants to ʊ formants.

    # Keep TRAP normalization consistent with the old Python behavior.
    - from: "a"
      to:   "æ"

    # "vowel", "towel" (and similar -owel words):
    # In US screen-reader speech it often sounds clearer to render the final "-el" nucleus
    # more like "-ol" (Eloquence-ish), rather than a distinct schwa+L.
    # Keep this US-only; en-gb keeps the darker /əl/ ending.
    - from: "æʊəl"
      to:   "æʊol"
      when:
        atWordEnd: true
    - from: "æʊəɫ"
      to:   "æʊol"
      when:
        atWordEnd: true

    # eSpeak emits ɐ for a lot of reduced vowels (e.g. "apply" starts with ɐ-).
    # In US speech this can sound a bit "boxy" in our formant table.
    - from: "ɐ"
      to:   "ə"

    # US GOOSE vowel: keep it a touch more forward/bright so words like "pool" and "two" don't drift UK-ish.
    # (en-gb keeps its own quality; this only affects en-us via the ᵿ key.)
    - from: "ᵾ"
      to:   "ᵿ"

    # US GOAT (oʊ) can sound oddly "midwestern" if the /o/ start is too back.
    # Use a slightly more fronted internal variant for en-us.
    - from: "o"
      to:   "ᵒ"

    # US THOUGHT vowel: make /ɔ(ː)/ more open so it doesn't drift toward an "owe" quality.
    - from: "ɔː"
      to:   "ᴐː"
    - from: "ɔ"
      to:   "ᴐ"



    # US English: /-yond/ words are closer to LOT than THOUGHT (Eloquence-ish)
    - from: "jˈᴐnd"
      to:   "jˈᴒnd"
    - from: "jˌᴐnd"
      to:   "jˌᴒnd"
    # BIG ONE:
    # eSpeak's IPA often uses ɜ(ː) for NURSE even in en-us.
    # Force rhotic NURSE.
    - from: "ɜː"
      to:   "ɝː"
    - from: "ɜ"
      to:   "ɝ"    # In many common words ending in -art (start/smart/cart/apart/depart...),
    # /ɑːɹ/ and /ɑːɹt/ can sound overly open ("Australian") in a formant synth.
    # Nudge toward more central "uh" vowel for American sound.
    # Word-final R (star, car, far):
    - from: "ɑːɹ"
      to:   "ʌɹ"
      when:
        atWordEnd: true
    - from: "ɑɹ"
      to:   "ʌɹ"
      when:
        atWordEnd: true
    # Word-final Rt (start, cart, fart):
    - from: "ɑːɹt"
      to:   "ʌɹt"
      when:
        atWordEnd: true
    - from: "ɑɹt"
      to:   "ʌɹt"
      when:
        atWordEnd: true



    # Use a dedicated US /r/ variant.

    # NEAR / "ear" words in en-us (fear/hear/dear/ear):
    # Base en.yaml may brighten word-final /ɪɹ/ toward /iɹ/, which can make these sound too strong.
    # Undo that brightening only at word end, so fear/hear stay softer (ɪɹ), then r→ɻ below applies.
    - from: "iɹ"
      to:   "ɪɹ"
      when:
        atWordEnd: true
    # Safety: if /r/ is already mapped to ɻ earlier in the chain, still undo at word end.
    - from: "iɻ"
      to:   "ɪɻ"
      when:
        atWordEnd: true
    - from: "ɹ"
      to:   "ɻ"

    # In onsets (before a vowel), use the lighter alveolar approximant /ɹ/.
    # Keep the heavier ɻ for codas (word-final or before consonants).
    - from: "ɻ"
      to:   "ɹ"
      when:
        beforeClass: VOWELS


    # Word-final R: rely on singleWordTuning for final hold.
    # Don't add extra length mark - it causes "barky" over-stretched R on words like "star", "car".
    # The retroflex formants (esp. low F3) sound unnatural when held too long.

    # Undo the UK THOUGHT tweak from en.yaml (en.yaml maps ɔː -> ᴏː).
    - from: "ᴏ"
      to:   "ɔ"

    # NOTE:
    # We intentionally *do not* undo the base English fronting of long /uː/.
    # eSpeak's en-us still outputs uː in many common words (rules, do, you),
    # and the backer multilingual "u" vowel can make them sound like "roo".

# NOTE: The "ᵿ" (US GOOSE) phoneme is now defined in phonemes.yaml with
# US-tuned F2 values. No per-language phoneme override needed here.