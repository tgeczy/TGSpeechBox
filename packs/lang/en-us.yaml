# packs/lang/en-us.yaml
# English (US) overrides layered on top of default.yaml + en.yaml

settings:
  # Keep stop closures for clarity, but avoid the overly-clicky "always" mode
  # (helps clusters like "adjust" and "change" feel less springy).
  stopClosureMode: vowel-and-cluster
  # If a word ends in a consonant and the next word starts with a stop,
  # that word-initial stop can get swallowed (e.g. "... applications toolbar").
  # Turn on cluster gaps, and make *word-boundary* cluster gaps slightly longer
  # than in-word clusters for clarity, without going full "always".
  stopClosureClusterGapsEnabled: true
  stopClosureAfterNasalsEnabled: true

  # Allow gaps after nasals too, so phrases like "column two" don't swallow the /t/.
  stopClosureVowelGapMs: 18
  stopClosureVowelFadeMs: 4
  stopClosureClusterGapMs: 16
  stopClosureClusterFadeMs: 4
  stopClosureWordBoundaryClusterGapMs: 24
  stopClosureWordBoundaryClusterFadeMs: 4

  # Append a short silence token at end of utterance so the DSP can
  # crossfade aspiration/frication through voiceGenerator instead of
  # hitting the crude 4ms stopFade path.
  singleWordFinalFadeMs: 25
  clauseFinalFadeMs: 25

  # US: smoother overall, less breath noise on stop releases.
  postStopAspirationEnabled: true

  # Reduce hold time for word-final liquids (R, L) to avoid "pirate R" on
  # words like "star", "car", "far". The retroflex R with its low F3 sounds
  # unnatural when held too long. 0.4 = 40% of normal hold time.
  singleWordFinalLiquidHoldScale: 0.4

  # US tends to shorten length-marked vowels in word-final closed syllables
  # (e.g. "tools", "smooth").
  lengthenedVowelFinalCodaScale: 0.90

  # Allow length marks to apply to consonants too (for word-final R lengthening)
  applyLengthenedScaleToVowelsOnly: false
  # Make length marks more effective.
  # 1.05 was too subtle - FORCE vowels (for, door, snore) need more presence before R.
  # With 1.15, a double length mark (ːː) gives ~32% more length.
  lengthenedScale: 1.15

  # Use the US/CA GOOSE vowel variant.
  englishLongUShortenEnabled: true
  englishLongUWordFinalScale: 0.95
  englishLongUKey: "ᵿ"

  spellingDiphthongMode: monophthong

  # Shorten semivowel offglides in diphthongs (e.g. the "j" in FACE eɪ→ej).
  # This makes diphthongs like "applications" sound more staccato/natural.
  semivowelOffglideScale: 0.65

  # Keep defaults conservative: avoid heavy cross-phoneme shaping here.
  coarticulationEnabled: false
  trajectoryLimitEnabled: false
  microprosodyEnabled: false
  rateReductionEnabled: true
  segmentBoundarySkipVowelToLiquid: false
  coarticulationVelarPinchEnabled: false
  coarticulationGraduated: false
  coarticulationAdjacencyMaxConsonants: 0
  phraseFinalLengtheningEnabled: false
  phraseFinalLengtheningNucleusOnlyMode: false
  microprosodyVoicelessF0RaiseEnabled: false
  microprosodyVoicedF0LowerEnabled: true
  nasalizationAnticipatoryEnabled: false
  liquidDynamics:
    enabled: true
    # American-style rhotic quality - creates movement in the R
    rhoticF3Dip:
      enabled: false
      # Raised from 1450 to reduce "Australian" tongue-press sound
      f3Minimum: 1550
      # Reduced from 0.45 to make R feel less "drawn out"
      dipDurationPct: 0.25
  lengthContrast:
    enabled: false
  allophoneRules:
    enabled: true
    rules:
    # ── Stop aspiration scaling ──────────────────────────────────
    # Disabled: these weren't active before and cause regression on
    # numbers like "442" where word-boundary /t/ needs full aspiration.
    #- name: aspiration_word_initial_stressed
    #  tokenType: aspiration
    #  position: word-initial
    #  stress: prev-stressed
    #  action: scale
    #  durationScale: 0.8
    #  fadeScale: 0.8
    #  fieldScales:
    #    aspirationAmplitude: 0.8
    #    fricationAmplitude: 0.8

    #- name: aspiration_word_initial
    #  tokenType: aspiration
    #  position: word-initial
    #  stress: unstressed
    #  action: scale
    #  durationScale: 0.5
    #  fadeScale: 0.5
    #  fieldScales:
    #    aspirationAmplitude: 0.5
    #    fricationAmplitude: 0.5

    #- name: aspiration_word_final
    #  tokenType: aspiration
    #  position: word-final
    #  action: scale
    #  durationScale: 0.1
    #  fadeScale: 0.1
    #  fieldScales:
    #    aspirationAmplitude: 0.1
    #    fricationAmplitude: 0.1

    #- name: aspiration_intervocalic
    #  tokenType: aspiration
    #  position: intervocalic
    #  action: scale
    #  durationScale: 0.2
    #  fadeScale: 0.2
    #  fieldScales:
    #    aspirationAmplitude: 0.2
    #    fricationAmplitude: 0.2

    # ── Intervocalic flapping (/t,d/ → [ɾ]) ─────────────────────
      - name: american_flapping
        phonemes: [t, d]
        position: intervocalic
        stress: next-unstressed
        action: replace
        replaceTo: ɾ
        replaceDurationMs: 22.0
        replaceRemovesClosure: true
        replaceClosureScale: 0.3
        replaceRemovesAspiration: false

    # ── /l/ darkness by position ─────────────────────────────────
      - name: dark_l_post_vocalic
        phonemes: [l, ɫ]
        position: post-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.8
          - field: pf2
            targetHz: 900.0
            blend: 0.8

      - name: dark_l_syllabic
        phonemes: [l, ɫ]
        position: syllabic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.9
          - field: pf2
            targetHz: 900.0
            blend: 0.9

      - name: light_l_pre_vocalic
        phonemes: [l, ɫ]
        position: pre-vocalic
        action: shift
        fieldShifts:
          - field: cf2
            targetHz: 900.0
            blend: 0.2
          - field: pf2
            targetHz: 900.0
            blend: 0.2

    # ── Glottal reinforcement (word-final voiceless stops) ───────
    # Disabled: the unreleased rule already softens word-final stops,
    # and the inserted [ʔ] was adding too much to the cluster.
    #- name: glottal_reinforcement
    #  flags: [stop]
    #  notFlags: [voiced]
    #  position: word-final
    #  action: insert-before
    #  insertPhoneme: ʔ
    #  insertDurationMs: 18.0
    #  insertFadeMs: 3.0
    #  insertContexts: ["V_#"]

    # ── Unreleased word-final stops (softer, airier release) ─────
    # Spectral shaping: cut low-freq thump (pa1, pa2), boost high-freq
    # air (pa4, pa5) to make the burst sound released-but-soft rather
    # than hard and clicky. Works within the existing time budget —
    # no extra tokens, no added gaps.
      - name: unreleased_word_final
        flags: [stop]
        notFlags: [voiced]
        position: word-final
        action: scale
        durationScale: 0.85
        fieldScales:
          fricationAmplitude: 0.84
          aspirationAmplitude: 0.55
          pa1: 0.3
          pa2: 0.5
          pa4: 1.3
          pa5: 1.4
  boundarySmoothing:
    enabled: false
    f1Scale: 0.6
    f3Scale: 1.2
    nasalF1Instant: true
    stopToFricFadeMs: 15
  trajectoryLimit:
    enabled: false
    applyAcrossWordBoundary: true
  # ------------------------------------------------------------------
  # Special coarticulation: YAML-driven Hz deltas on vowels adjacent
  # to specific consonants.  Runs *after* the locus coarticulation pass,
  # so these deltas stack on top of the DECTalk-style formant ramps.
  # ------------------------------------------------------------------
  specialCoarticulation:
    enabled: false
    maxDeltaHz: 400
    rules:
      # 1. Rhotic vowel coloring  (the signature American feature).
      #    /ɹ/ and /ɻ/ pull F3 down on the vowel next to them.
      #    liquid_dynamics handles the R *token* itself; this colors
      #    the *vowel* token, which is the perceptual cue for rhoticity.
      - name: rhotic-f3-lowering
        triggers: ["ɹ", "ɻ"]
        vowelFilter: all
        formant: f3
        deltaHz: -80
        side: both
        cumulative: true        # V between two R's gets double dose
        unstressedScale: 0.6    # less effect on reduced vowels
        phraseFinalStressedScale: 1.3  # phrase-final "star" gets extra color

      # 2. Labial rounding  — /w/, /b/, /p/, /m/ pull F2 down.
      #    Makes "water", "between", "maple" sound rounder.
      - name: labial-f2-lowering
        triggers: ["w", "b", "p", "m"]
        vowelFilter: all
        formant: f2
        deltaHz: -50
        side: both
        cumulative: false
        unstressedScale: 0.5

      # 3. Alveolar fronting of back vowels  — /t/, /d/, /n/, /s/, /z/
      #    raise F2 on back vowels, subtly fronting them.
      #    Replaces the old hardcoded alveolar-back-vowel experiment
      #    that was just removed from coarticulation.cpp.
      - name: alveolar-back-vowel-fronting
        triggers: ["t", "d", "n", "s", "z"]
        vowelFilter: back
        formant: f2
        deltaHz: 60
        side: both
        cumulative: false
        unstressedScale: 0.5

  # ------------------------------------------------------------------
  # Cluster timing: shorten consonants in clusters so "adjust",
  # "texts", "strengths" don't sound like each consonant was
  # dictated separately.  Also trims word-medial and word-final
  # obstruents for smoother connected speech.
  # ------------------------------------------------------------------
  clusterTiming:
    enabled: true
    fricBeforeStopScale: 0.65      # /st/ in "stop", "fast"
    stopBeforeFricScale: 0.70      # /ks/ in "box", "tax"
    fricBeforeFricScale: 0.75      # /sf/ rare but "asphalt"
    stopBeforeStopScale: 0.60      # /kt/ in "act", "fact"
    tripleClusterMiddleScale: 0.55 # middle C in /str/, /kst/
    affricateInClusterScale: 0.75  # /tʃ/ in "lunchbox"
    wordMedialConsonantScale: 0.85 # intervocalic C's
    wordFinalObstruentScale: 0.90  # final /t/, /d/, /s/ etc.
  legacyPitchMode: espeak_style
  legacyPitchInflectionScale : 1.4 
  singleWordClauseTypeOverrideCommaOnly: false
normalization:
  preReplacements:
    # FORCE vowels: Shorten the vowel when followed by a consonant (short, sport, report).
    # Open FORCE (door, score, for) keeps its natural length.
    # Must run FIRST, before tie-bar normalization and ᵊ insertion.
    - from: "oːɹ"
      to:   "oɹ"
      when:
        beforeClass: CONSONANTS
    - from: "ɔːɹ"
      to:   "ɔɹ"
      when:
        beforeClass: CONSONANTS

    # Protect PRICE/MOUTH diphthongs from broad TRAP rules (e.g. five/nine/out).
    # With tie-insensitive rule matching in the frontend, these match both 'aɪ' and 'a͡ɪ'.
    - from: "a͡ɪ"
      to:   "ɑ͡ɪ"
    - from: "a͡ʊ"
      to:   "ɑ͡ʊ"

    # FORCE vowels: The vowel before R gets swallowed too quickly.
    # Some consonants (f, m, b, d, st, word-initial) cause extra shortening.
    # Insert short ᵊ (semivowel) transition to give the vowel more presence.
    # f + FORCE (for, four):
    - from: "fˈoːɹ"
      to:   "fˈoːᵊɹ"
    - from: "fɔːɹ"
      to:   "fɔːᵊɹ"
    - from: "foːɹ"
      to:   "foːᵊɹ"
      # m + FORCE (more):
    - from: "mˈoːɹ"
      to:   "mˈoːᵊɹ"
    - from: "moːɹ"
      to:   "moːᵊɹ"
    # b + FORCE (bore, boar):
    - from: "bˈoːɹ"
      to:   "bˈoːᵊɹ"
    - from: "boːɹ"
      to:   "boːᵊɹ"
    # d + FORCE (door):
    - from: "dˈoːɹ"
      to:   "dˈoːᵊɹ"
    - from: "doːɹ"
      to:   "doːᵊɹ"
    # st + FORCE (store):
    - from: "stˈoːɹ"
      to:   "stˈoːᵊɹ"
    - from: "stoːɹ"
      to:   "stoːᵊɹ"
  classes:
    # Vowels (including schwa/r-colored and extra internal keys used by English packs).
    VOWELS: ["a", "e", "i", "o", "u", "ɐ", "ə", "ɜ", "ɝ", "ɑ", "ɒ", "ɔ", "ɛ", "æ", "ʊ", "ɪ", "ᵾ", "ᵿ", "ᴏ", "ᴐ", "ᴒ", "ã", "ẽ", "ĩ", "õ", "ũ", "ᴜ"]

    # Consonants (used for notBeforeClass checks, e.g. FORCE vowel lengthening).
    CONSONANTS: ["b", "c", "d", "f", "g", "h", "j", "k", "l", "m", "n", "p", "q", "r", "s", "t", "v", "w", "x", "z", "ŋ", "ɡ", "ɣ", "ɫ", "ɲ", "ɹ", "ɻ", "ɾ", "ʃ", "ʒ", "ʔ", "θ", "ð", "ç", "β", "t͡ʃ", "d͡ʒ", "t͡s", "d͡z"]

  replacements:
    # eSpeak (classic) en-us has a dictionary entry for "Microsoft" that produces
    # an "-soft" syllable with /ɑː/ ("microsaft"). "soft" by itself is /sɔft/.
    # Normalize the compound to use the same vowel as "soft".
    - from: "sˌɑːft"
      to:   "sˌɔft"
    - from: "sˌɑft"
      to:   "sˌɔft"

    # Acronyms like "NVDA" / "GPDA" end in ...diːˈeɪ. If we rewrite eɪ -> ej,
    # the final letter "A" can sound like "dee-yay". Keep that final A as a
    # long monophthong instead.
    - from: "iːˈeɪ"
      to:   "iːˈeː"
    - from: "iːˈe͡ɪ"
      to:   "iːˈeː"
    - from: "iːˌeɪ"
      to:   "iːˌeː"
    - from: "iːˌe͡ɪ"
      to:   "iːˌeː"



    # Make FACE (eɪ) sound like a real diphthong instead of a flat "e".
    # Using a semivowel offglide gives a clearer movement in our formant table.
    - from: "eɪ"
      to:   "ej"
    - from: "e͡ɪ"
      to:   "e͡j"

    # GOAT words like "no", "go", "so" need care:
    # - Full oʊ sounds like "oww" (too much W)
    # - Bare o sounds clipped/Minnesota
    # Solution: lengthen the vowel without the offglide for a smooth sustained sound.
    - from: "nˈoʊ"
      to:   "nˈoː"
    - from: "nˈo͡ʊ"
      to:   "nˈoː"
    - from: "ɡˈoʊ"
      to:   "ɡˈoː"
    - from: "ɡˈo͡ʊ"
      to:   "ɡˈoː"
    - from: "sˈoʊ"
      to:   "sˈoː"
    - from: "sˈo͡ʊ"
      to:   "sˈoː"
    # Standalone letter "O"
    - from: "ˈoʊ"
      to:   "ˈoː"
    - from: "ˈo͡ʊ"
      to:   "ˈoː"


    # Treat GOAT (oʊ) as vowel+glide so it doesn't split into two vowel beats.
    # But in many common words GOAT is an unstressed prefix followed by a consonant
    # that starts the stressed syllable (e.g. "okay" = oʊkˈeɪ). Converting oʊ -> ow
    # makes the /w/ too prominent ("oww-kay"). Collapse those patterns first.
    - from: "oʊkˈ"
      to:   "okˈ"
    - from: "oʊbˈ"
      to:   "obˈ"
    - from: "oʊdˈ"
      to:   "odˈ"
    - from: "oʊfˈ"
      to:   "ofˈ"
    - from: "oʊpˈ"
      to:   "opˈ"
    - from: "oʊtˈ"
      to:   "otˈ"
    - from: "oʊsˈ"
      to:   "osˈ"
    - from: "oʊmˈ"
      to:   "omˈ"
    - from: "oʊlˈ"
      to:   "olˈ"

    # Keep TRAP normalization consistent with the old Python behavior.
    - from: "a"
      to:   "æ"

    # "vowel", "towel" (and similar -owel words):
    # In US screen-reader speech it often sounds clearer to render the final "-el" nucleus
    # more like "-ol" (Eloquence-ish), rather than a distinct schwa+L.
    # Keep this US-only; en-gb keeps the darker /əl/ ending.
    - from: "æʊəl"
      to:   "æʊol"
      when:
        atWordEnd: true
    - from: "æʊəɫ"
      to:   "æʊol"
      when:
        atWordEnd: true

    # eSpeak emits ɐ for a lot of reduced vowels (e.g. "apply" starts with ɐ-).
    # In US speech this can sound a bit "boxy" in our formant table.
    - from: "ɐ"
      to:   "ə"

    # US GOOSE vowel: keep it a touch more forward/bright so words like "pool" and "two" don't drift UK-ish.
    # (en-gb keeps its own quality; this only affects en-us via the ᵿ key.)
    - from: "ᵾ"
      to:   "ᵿ"

    # US GOAT (oʊ) can sound oddly "midwestern" if the /o/ start is too back.
    # Use a slightly more fronted internal variant for en-us.
    - from: "o"
      to:   "ᵒ"

    # US THOUGHT vowel: make /ɔ(ː)/ more open so it doesn't drift toward an "owe" quality.
    - from: "ɔː"
      to:   "ᴐː"
    - from: "ɔ"
      to:   "ᴐ"



    # US English: /-yond/ words are closer to LOT than THOUGHT (Eloquence-ish)
    - from: "jˈᴐnd"
      to:   "jˈᴒnd"
    - from: "jˌᴐnd"
      to:   "jˌᴒnd"
    # BIG ONE:
    # eSpeak's IPA often uses ɜ(ː) for NURSE even in en-us.
    # Force rhotic NURSE.
    - from: "ɜː"
      to:   "ɝː"
    - from: "ɜ"
      to:   "ɝ"    # In many common words ending in -art (start/smart/cart/apart/depart...),
    # /ɑːɹ/ and /ɑːɹt/ can sound overly open ("Australian") in a formant synth.
    # Nudge toward more central "uh" vowel for American sound.
    # Word-final R (star, car, far):
    - from: "ɑːɹ"
      to:   "ʌɹ"
      when:
        atWordEnd: true
    - from: "ɑɹ"
      to:   "ʌɹ"
      when:
        atWordEnd: true
    # Word-final Rt (start, cart, fart):
    - from: "ɑːɹt"
      to:   "ʌɹt"
      when:
        atWordEnd: true
    - from: "ɑɹt"
      to:   "ʌɹt"
      when:
        atWordEnd: true



    # Use a dedicated US /r/ variant.

    # NEAR / "ear" words in en-us (fear/hear/dear/ear):
    # Base en.yaml may brighten word-final /ɪɹ/ toward /iɹ/, which can make these sound too strong.
    # Undo that brightening only at word end, so fear/hear stay softer (ɪɹ), then r→ɻ below applies.
    - from: "iɹ"
      to:   "ɪɹ"
      when:
        atWordEnd: true
    # Safety: if /r/ is already mapped to ɻ earlier in the chain, still undo at word end.
    - from: "iɻ"
      to:   "ɪɻ"
      when:
        atWordEnd: true
    - from: "ɹ"
      to:   "ɻ"

    # In onsets (before a vowel), use the lighter alveolar approximant /ɹ/.
    # Keep the heavier ɻ for codas (word-final or before consonants).
    - from: "ɻ"
      to:   "ɹ"
      when:
        beforeClass: VOWELS


    # Word-final R: rely on singleWordTuning for final hold.
    # Don't add extra length mark - it causes "barky" over-stretched R on words like "star", "car".
    # The retroflex formants (esp. low F3) sound unnatural when held too long.

    # Undo the UK THOUGHT tweak from en.yaml (en.yaml maps ɔː -> ᴏː).
    - from: "ᴏ"
      to:   "ɔ"

    # NOTE:
    # We intentionally *do not* undo the base English fronting of long /uː/.
    # eSpeak's en-us still outputs uː in many common words (rules, do, you),
    # and the backer multilingual "u" vowel can make them sound like "roo".

# NOTE: The "ᵿ" (US GOOSE) phoneme is now defined in phonemes.yaml with
# US-tuned F2 values. No per-language phoneme override needed here.