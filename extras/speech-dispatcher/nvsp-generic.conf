# NV Speech Player (nvspRender) generic output module for Speech Dispatcher
#
# This uses Speech Dispatcher's built-in "sd_generic" module: no C module code
# in Speech Dispatcher is required.
#
# Pipeline:
#   SSIP text ($DATA) -> espeak-ng (text -> IPA) -> nvspRender (IPA -> raw PCM) -> aplay
#
# Notes:
# - nvspRender (built from this repo) outputs raw 16-bit signed little-endian PCM
#   at 22050 Hz.
# - Edit the --packdir value below to point at the directory containing "packs/".
#
# References/examples:
# - Debian speech-dispatcher generic module configs show the expected variables
#   ($DATA, $LANGUAGE, $VOICE, $PITCH, $RATE, $VOLUME) and conversion knobs.
# - "piper" generic module configs commonly use aplay with --output-raw pipelines.

# Where to look for module logs (enabled via Debug 1): see speechd.conf.
Debug 0

# Strip characters that would break the shell command (we quote $DATA with ").
# This replaces these characters with whitespace.
GenericStripPunctChars "\""

# Punctuation control is handled by Speech Dispatcher; for this pipeline we don't
# pass extra punctuation flags to espeak-ng.
GenericPunctNone ""
GenericPunctSome ""
GenericPunctMost ""
GenericPunctAll ""

# Synthesis command.
#
# IMPORTANT:
# - "$DATA" is substituted by Speech Dispatcher.
# - The command must stop on SIGKILL.
#
# Update the paths if you install nvspRender somewhere else.
#
GenericExecuteSynth \
"printf %s \"$DATA\" | \
  espeak-ng -q -v $LANGUAGE --ipa=1 --stdin | \
  nvspRender --packdir /usr/share/nvspeechplayer --lang $LANGUAGE --rate $RATE --pitch $PITCH --volume $VOLUME | \
  aplay -q -r 16000 -f S16_LE -t raw -"

# External commands required by the pipeline (must be in PATH).
GenericCmdDependency "espeak-ng"
GenericCmdDependency "nvspRender"
GenericCmdDependency "aplay"

# Optional (used for sound icons).
GenericSoundIconFolder "/usr/share/sounds/sound-icons/"

# Language mapping. The first field is what SSIP clients pass, the second is what we
# pass to espeak-ng (and also to nvspRender's --lang), the third is the encoding.
#
# Keep this list in sync with packs/lang/*.yaml if you want full coverage.
GenericLanguage "bg" "bg" "utf-8"
GenericLanguage "cs" "cs" "utf-8"
GenericLanguage "da" "da" "utf-8"
GenericLanguage "de" "de" "utf-8"
GenericLanguage "en" "en" "utf-8"
GenericLanguage "en-us" "en-us" "utf-8"
GenericLanguage "en_US" "en-us" "utf-8"
GenericLanguage "en-gb" "en-gb" "utf-8"
GenericLanguage "en_GB" "en-gb" "utf-8"
GenericLanguage "en-ca" "en-ca" "utf-8"
GenericLanguage "en_CA" "en-ca" "utf-8"
GenericLanguage "es" "es" "utf-8"
GenericLanguage "es-mx" "es-mx" "utf-8"
GenericLanguage "es_MX" "es-mx" "utf-8"
GenericLanguage "fi" "fi" "utf-8"
GenericLanguage "fr" "fr" "utf-8"
GenericLanguage "hr" "hr" "utf-8"
GenericLanguage "hu" "hu" "utf-8"
GenericLanguage "it" "it" "utf-8"
GenericLanguage "nl" "nl" "utf-8"
GenericLanguage "pl" "pl" "utf-8"
GenericLanguage "pt" "pt" "utf-8"
GenericLanguage "pt-br" "pt-br" "utf-8"
GenericLanguage "pt_BR" "pt-br" "utf-8"
GenericLanguage "ro" "ro" "utf-8"
GenericLanguage "ru" "ru" "utf-8"
GenericLanguage "sk" "sk" "utf-8"
GenericLanguage "sv" "sv" "utf-8"
GenericLanguage "uk" "uk" "utf-8"
GenericLanguage "zh" "zh" "utf-8"

# Voices: expose one voice per language. $VOICE is not currently used by nvspRender,
# but Speech Dispatcher expects voices to be enumerated.
AddVoice "bg" "MALE1" "bg"
AddVoice "cs" "MALE1" "cs"
AddVoice "da" "MALE1" "da"
AddVoice "de" "MALE1" "de"
AddVoice "en" "MALE1" "en"
AddVoice "en-us" "MALE1" "en-us"
AddVoice "en-gb" "MALE1" "en-gb"
AddVoice "en-ca" "MALE1" "en-ca"
AddVoice "es" "MALE1" "es"
AddVoice "es-mx" "MALE1" "es-mx"
AddVoice "fi" "MALE1" "fi"
AddVoice "fr" "MALE1" "fr"
AddVoice "hr" "MALE1" "hr"
AddVoice "hu" "MALE1" "hu"
AddVoice "it" "MALE1" "it"
AddVoice "nl" "MALE1" "nl"
AddVoice "pl" "MALE1" "pl"
AddVoice "pt" "MALE1" "pt"
AddVoice "pt-br" "MALE1" "pt-br"
AddVoice "ro" "MALE1" "ro"
AddVoice "ru" "MALE1" "ru"
AddVoice "sk" "MALE1" "sk"
AddVoice "sv" "MALE1" "sv"
AddVoice "uk" "MALE1" "uk"
AddVoice "zh" "MALE1" "zh"

# Parameter conversion (SSIP -> nvspRender args)
#
# Speech Dispatcher (SSIP) uses -100..+100 for rate/pitch/volume.
#
# RATE: pass through as -100..+100 (nvspRender maps to speed multiplier internally)
GenericRateAdd 0
GenericRateMultiply 100
GenericRateForceInteger 1

# PITCH: map -100..+100 -> 0..100 (nvspRender maps slider -> base Hz internally)
GenericPitchAdd 50
GenericPitchMultiply 50
GenericPitchForceInteger 1

# VOLUME: map -100..+100 -> 0.0..2.0 (linear gain multiplier)
GenericVolumeAdd 1
GenericVolumeMultiply 1
GenericVolumeForceInteger 0
